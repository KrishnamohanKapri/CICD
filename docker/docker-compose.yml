
# ## Usage Guide:

# ### 1. **Full Build** (only when `CROSS_COMPILE_WINDOWS` changes):
#
# docker compose up build-full
# 
# ### 2. **Install Eclipse** (if not already installed):
#
# docker compose up install-eclipse
#
# ### 3. **Clean Build Artifacts** (CMake cache, generated files):
#
# docker compose up clean
#
# ### 4. **Individual Gradle Tasks**:
#
# # Publish plugins
# docker compose up publish-plugins

# # Generate all models
# docker compose up generate

# # Compile all generated code
# docker compose up compile

# # Build OCL components
# docker compose up build-ocl
#
# ### 5. **Interactive Shell** (detached mode):
#
# # Start container in background
# docker compose up -d shell

# # Enter the container
# docker compose exec shell bash

# # When done, exit the shell (container keeps running)
# exit

# # Stop the container when you're done
# docker compose stop shell
# # ## Notes:

# 1. **`build-full` service**: Runs the complete build process (install Eclipse if needed, generate, compile, build OCL). Only run when `CROSS_COMPILE_WINDOWS` changes in `MDE4CPP_Generator.properties`.
# 2. **`install-eclipse` service**: Installs Eclipse and plugins. Skips if Eclipse is already installed.
# 3. **`clean` service**: Removes CMake cache files, build artifacts, and `src_gen` directories. Preserves `application/lib` and `application/bin`.
# 4. **All services share the same image**: They all use `mde4cpp:latest` to avoid rebuilding.
# 5. **System packages** (cmake, gcc, etc.) are installed in the Docker image at build time.
# 6. **`shell` service**: Runs `tail -f /dev/null` to keep the container alive in detached mode, allowing you to `exec` into it anytime.

services:
  # Full build service - Run this only when CROSS_COMPILE_WINDOWS changes in MDE4CPP_Generator.properties
  # Usage: docker compose up build-full
  build-full:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: mde4cpp:latest
    container_name: mde4cpp-build-full
    working_dir: /home/mde4cpp
    stdin_open: true
    tty: true
    volumes:
      - ../:/home/mde4cpp
    command: >
      /bin/bash -c "
      cd /home/mde4cpp &&
      ./docker/scripts/install-eclipse.sh &&
      ./docker/scripts/setup-setenv.sh &&
      . ./setenv &&
      ./docker/scripts/build-full.sh &&
      echo '✓ Build complete!'
      "

  # Install Eclipse and plugins (if not already installed)
  # Usage: docker compose up install-eclipse
  install-eclipse:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: mde4cpp:latest
    container_name: mde4cpp-install-eclipse
    working_dir: /home/mde4cpp
    volumes:
      - ../:/home/mde4cpp
    command: >
      /bin/bash -c "
      cd /home/mde4cpp &&
      ./docker/scripts/install-eclipse.sh &&
      echo '✓ Eclipse installation complete!'
      "

  # Clean CMake cache files and build artifacts
  # Preserves application/lib and application/bin directories
  # Usage: docker compose up clean
  clean:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: mde4cpp:latest
    container_name: mde4cpp-clean
    working_dir: /home/mde4cpp
    volumes:
      - ../:/home/mde4cpp
    command: >
      /bin/bash -c "
      cd /home/mde4cpp &&
      ./docker/scripts/clean-cmake.sh &&
      echo '✓ Cleanup complete!'
      "

  # Publish Gradle plugins to Maven local
  # Usage: docker compose up publish-plugins
  publish-plugins:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: mde4cpp:latest
    container_name: mde4cpp-publish-plugins
    working_dir: /home/mde4cpp
    volumes:
      - ../:/home/mde4cpp
    command: >
      /bin/bash -c "
      cd /home/mde4cpp &&
      ./docker/scripts/setup-setenv.sh &&
      . ./setenv &&
      ./application/tools/gradlew gradlePlugins:publishMDE4CPPPluginsToMavenLocal --no-daemon
      "

  # Generate all models
  # Usage: docker compose up generate
  generate:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: mde4cpp:latest
    container_name: mde4cpp-generate
    working_dir: /home/mde4cpp
    volumes:
      - ../:/home/mde4cpp
    command: >
      /bin/bash -c "
      cd /home/mde4cpp &&
      ./docker/scripts/setup-setenv.sh &&
      . ./setenv &&
      ./application/tools/gradlew generateAll --no-daemon
      "

  # Compile all generated code
  # Usage: docker compose up compile
  compile:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: mde4cpp:latest
    container_name: mde4cpp-compile
    working_dir: /home/mde4cpp
    volumes:
      - ../:/home/mde4cpp
    command: >
      /bin/bash -c "
      cd /home/mde4cpp &&
      ./docker/scripts/setup-setenv.sh &&
      . ./setenv &&
      ./application/tools/gradlew compileAll --no-daemon
      "

  # Build OCL components
  # Usage: docker compose up build-ocl
  build-ocl:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: mde4cpp:latest
    container_name: mde4cpp-build-ocl
    working_dir: /home/mde4cpp
    volumes:
      - ../:/home/mde4cpp
    command: >
      /bin/bash -c "
      cd /home/mde4cpp &&
      ./docker/scripts/setup-setenv.sh &&
      . ./setenv &&
      ./application/tools/gradlew src:buildOCLAll --no-daemon
      "

  # Interactive shell service - runs in detached mode
  # Usage: 
  #   1. docker compose up -d shell
  #   2. docker compose exec shell bash
  shell:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: mde4cpp:latest
    container_name: mde4cpp-shell
    working_dir: /home/mde4cpp
    volumes:
      - ../:/home/mde4cpp
    command: /bin/bash -c "tail -f /dev/null"
    # Keep container running indefinitely for exec access